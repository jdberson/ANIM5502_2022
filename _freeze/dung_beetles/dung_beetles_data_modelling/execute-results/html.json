{
  "hash": "a7cea6dc527f00fb86628976314e3b59",
  "result": {
    "markdown": "---\ntitle: \"Data modelling\"\neditor_options: \n  chunk_output_type: inline\n---\n\n\n## Setup\n\nHere we load the packages, set the ggplot theme and load the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\")\nlibrary(\"broom\")\nlibrary(\"broom.mixed\")\nlibrary(\"emmeans\")\nlibrary(\"lme4\")\nlibrary(\"car\")\n```\n:::\n\n\nSet the ggplot theme for all plots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_minimal())\ntheme_update(strip.text = element_text(face = \"bold\", size=10, hjust=0), \n             strip.background = element_rect(fill = \"grey80\", colour = NA),\n             axis.text = element_text(size=10, colour = \"black\"),\n             axis.title = element_text(size=12, colour = \"black\"))\n```\n:::\n\n\nImport the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read in the data\ndb_data <- \n  read_csv(\"data/db_data.csv\") %>%\n  \n  # Some R packages require factors to be explicit\n  mutate(across(.cols = c(id:shipment, treatment:sex), as.factor))\n```\n:::\n\n\n## Hypothesis #1a\n\nFirst we want to know whether the treatment had an immediate effect on beetle morphology, and whether this effect differed for the two species.\n\nRecall from our data exploration that two of the *Onthophagus vacca* shipments did not have both treatments. We will filter these out for this analysis, as well as generations other than the first generation.\n\nHere, we first look at the effect on **pronotum width**.\n\n### Step 1: pepare the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter data\ndb_data_F1 <-\n  db_data %>%\n              filter(generation == 1 &\n                     !shipment %in% c(\"5A\", \"5B\")) %>%\n  droplevels()\n\n# Check sample sizes\ndb_data_F1 %>%\n  drop_na(pronotum_width) %>%\n  group_by(treatment, sex, shipment, species) %>%\n  count()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"treatment\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"shipment\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"species\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"CT\",\"2\":\"F\",\"3\":\"2\",\"4\":\"Onthophagus vacca\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"F\",\"3\":\"4\",\"4\":\"Onthophagus vacca\",\"5\":\"25\"},{\"1\":\"CT\",\"2\":\"F\",\"3\":\"8\",\"4\":\"Onthophagus andalusicus\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"F\",\"3\":\"9\",\"4\":\"Onthophagus andalusicus\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"M\",\"3\":\"2\",\"4\":\"Onthophagus vacca\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"M\",\"3\":\"4\",\"4\":\"Onthophagus vacca\",\"5\":\"25\"},{\"1\":\"CT\",\"2\":\"M\",\"3\":\"8\",\"4\":\"Onthophagus andalusicus\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"M\",\"3\":\"9\",\"4\":\"Onthophagus andalusicus\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"F\",\"3\":\"2\",\"4\":\"Onthophagus vacca\",\"5\":\"40\"},{\"1\":\"Q\",\"2\":\"F\",\"3\":\"4\",\"4\":\"Onthophagus vacca\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"F\",\"3\":\"8\",\"4\":\"Onthophagus andalusicus\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"F\",\"3\":\"9\",\"4\":\"Onthophagus andalusicus\",\"5\":\"14\"},{\"1\":\"Q\",\"2\":\"M\",\"3\":\"2\",\"4\":\"Onthophagus vacca\",\"5\":\"40\"},{\"1\":\"Q\",\"2\":\"M\",\"3\":\"4\",\"4\":\"Onthophagus vacca\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"M\",\"3\":\"8\",\"4\":\"Onthophagus andalusicus\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"M\",\"3\":\"9\",\"4\":\"Onthophagus andalusicus\",\"5\":\"8\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Step 2: fit the model\n\nHere we fit the model that tests whether there is a treatment effect on pronotum width, if this differs by species (treatment\\*species term), if males and females differ in their pronotum width (sex term) and whether there were any differences among the different shipments (the (1\\|shipment) random effect term).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit the model\nm1_pw <- lmer(pronotum_width ~ treatment*species + sex + (1|shipment),\n              data = db_data_F1)\n```\n:::\n\n\n### Step 3: check model assumptions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fitted vs residuals plot\nplot(m1_pw)\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Histogram of residuals\nggplot(data = augment(m1_pw), aes(x = .resid)) +\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n\n\nThose diagnostic plots look OK to me.\n\n### Step 4: look at model results\n\nNow that we have fit our model and checked that the model assumptions look OK, we want to know the answer to the questions we are asking our model to investigate (see above).\n\nWe will use the Anova function from the car package (notice the capital 'A') to test the statistical significance for each model term.\n\n**Important** There are lots of problems with *P* values and null hypothesis significance testing. These are important to be aware of but that is not the focus of this unit. We can discuss these during our next meeting.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAnova(m1_pw)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Chisq\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Df\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Pr(>Chisq)\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"6.076304e+01\",\"2\":\"1\",\"3\":\"6.437523e-15\",\"_rn_\":\"treatment\"},{\"1\":\"6.087242e-04\",\"2\":\"1\",\"3\":\"9.803163e-01\",\"_rn_\":\"species\"},{\"1\":\"3.638679e-02\",\"2\":\"1\",\"3\":\"8.487189e-01\",\"_rn_\":\"sex\"},{\"1\":\"2.800405e+01\",\"2\":\"1\",\"3\":\"1.210616e-07\",\"_rn_\":\"treatment:species\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Step 5: understand the model results\n\nOur model is telling us that we have evidence for an effect of treatment on pronotum width and that this effect depends on the species being measured (statistically significant treatment:species term).\n\nWhat is difficult to understand from the model output is *how* the treatment is affecting pronotum width and *how* this effect differs for each species.\n\nTo understand these effects we can look at the estimated marginal means:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm1_pw_emm <- emmeans(m1_pw, ~treatment*species)\n\n# Test for a treatment effect for each species separately\ncontrast(m1_pw_emm, by = \"species\") %>% tidy()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"species\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"term\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"contrast\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"null.value\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"estimate\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"std.error\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"adj.p.value\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Onthophagus andalusicus\",\"2\":\"treatment\",\"3\":\"CT effect\",\"4\":\"0\",\"5\":\"-0.30668351\",\"6\":\"0.03323819\",\"7\":\"315.0644\",\"8\":\"-9.226840\",\"9\":\"4.165179e-18\"},{\"1\":\"Onthophagus andalusicus\",\"2\":\"treatment\",\"3\":\"Q effect\",\"4\":\"0\",\"5\":\"0.30668351\",\"6\":\"0.03323819\",\"7\":\"315.0644\",\"8\":\"9.226840\",\"9\":\"4.165179e-18\"},{\"1\":\"Onthophagus vacca\",\"2\":\"treatment\",\"3\":\"CT effect\",\"4\":\"0\",\"5\":\"-0.06082038\",\"6\":\"0.03241196\",\"7\":\"315.5278\",\"8\":\"-1.876479\",\"9\":\"6.151233e-02\"},{\"1\":\"Onthophagus vacca\",\"2\":\"treatment\",\"3\":\"Q effect\",\"4\":\"0\",\"5\":\"0.06082038\",\"6\":\"0.03241196\",\"7\":\"315.5278\",\"8\":\"1.876479\",\"9\":\"6.151233e-02\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nWe can see that for both species those beetles in the CT treatment tend to be smaller, but that this effect is larger for *Onthophagus andalusicus*.\n\n### Step 6: visualise model predictions alongside raw data\n\nSo far this has been all very 'black box' - we have run a model and got some results. We have some idea of what the model is telling us, but how well does the model reflect the raw data? It's also often much easier to communicate our results using a figure rather than just numbers in a table.\n\nThe following figure plots the the mean pronotum width for each species/treatment combination that is predicted by the model, the standard errors for these means, along with the raw data points.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Notice the use of tidy() from the generics package\nggplot(data = tidy(m1_pw_emm), \n       aes(x = treatment, y = estimate, colour = treatment, shape = treatment)) +\n  geom_point(size = 2) +\n  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0) + \n  geom_jitter(data = db_data_F1, aes(x = treatment, y = pronotum_width, colour = treatment), width = 0.2, alpha = 0.2) +\n  # The following line could be used to change the colours\n  #scale_colour_viridis_d() +\n  facet_wrap(~species, ncol = 2) +\n  labs(y = \"Pronotum width (mm)\", x = \"Treament\") +\n  theme(legend.position = \"none\") +\n  theme(strip.text = element_text(face = \"italic\"))\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n## Hypothesis #1b\n\nAbove we looked at pronotum width, now let's ask the same questions but examining **head horns**. Because head horn size will increase with pronotum width, we want to look at the size of the horn *relative* to body size. To do this we simply include pronotum_width as another explanatory variable.\n\nWe will follow the same steps as we did with pronotum width...\n\n### Step 1: prepare the data\n\nAlready done! Move to step 2.\n\n### Step 2: fit the model\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit the model\nm1_hh <- lmer(head_horn ~ pronotum_width + treatment*species + (1|shipment),\n              data = db_data_F1)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nboundary (singular) fit: see help('isSingular')\n```\n:::\n:::\n\n\nYou will see we get an error: boundary (singular) fit: see help('isSingular').\n\nThis is not an uncommon error, and seems to be happening because there is no variation associated with 'shipment'. Increasing our sample size may help with this. For now I think it's fine to push on.\n\n### Step 3: check model assumptions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fitted vs residuals plot\nplot(m1_hh)\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Histogram of residuals\nggplot(data = augment(m1_hh), aes(x = .resid)) +\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n:::\n\n\nThese plots don't look wonderful but I think they are OK for our purposes.\n\n### Step 4: look at model results\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAnova(m1_hh)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Chisq\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Df\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Pr(>Chisq)\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"487.532463\",\"2\":\"1\",\"3\":\"4.905947e-108\",\"_rn_\":\"pronotum_width\"},{\"1\":\"4.247608\",\"2\":\"1\",\"3\":\"3.930565e-02\",\"_rn_\":\"treatment\"},{\"1\":\"95.378283\",\"2\":\"1\",\"3\":\"1.572695e-22\",\"_rn_\":\"species\"},{\"1\":\"5.901039\",\"2\":\"1\",\"3\":\"1.513196e-02\",\"_rn_\":\"treatment:species\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nThe model is suggesting that there is a treatment effect on horns, and that this effect differs by species.\n\n### Step 5: understand the model results\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemmeans(m1_hh, ~ treatment | species) %>%\n  contrast() %>% tidy()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"species\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"term\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"contrast\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"null.value\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"estimate\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"std.error\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"adj.p.value\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Onthophagus andalusicus\",\"2\":\"treatment\",\"3\":\"CT effect\",\"4\":\"0\",\"5\":\"0.0199301\",\"6\":\"0.04579592\",\"7\":\"73.45082\",\"8\":\"0.4351939\",\"9\":\"0.664697836\"},{\"1\":\"Onthophagus andalusicus\",\"2\":\"treatment\",\"3\":\"Q effect\",\"4\":\"0\",\"5\":\"-0.0199301\",\"6\":\"0.04579592\",\"7\":\"73.45082\",\"8\":\"-0.4351939\",\"9\":\"0.664697836\"},{\"1\":\"Onthophagus vacca\",\"2\":\"treatment\",\"3\":\"CT effect\",\"4\":\"0\",\"5\":\"-0.1164373\",\"6\":\"0.03737660\",\"7\":\"83.28862\",\"8\":\"-3.1152453\",\"9\":\"0.002520946\"},{\"1\":\"Onthophagus vacca\",\"2\":\"treatment\",\"3\":\"Q effect\",\"4\":\"0\",\"5\":\"0.1164373\",\"6\":\"0.03737660\",\"7\":\"83.28862\",\"8\":\"3.1152453\",\"9\":\"0.002520946\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nWe see that we have evidence that *O. vacca* relative horn size is on average larger in the Q treatment, but that there is no difference between treatments for *O. andalusicus* horns.\n\n### Step 6: visualise model predictions alongside raw data\n\nHere we plot the predicted head horn size for a given pronotum width, separately for each treatment x species combination (you will see there are four lines), along with the raw data.\n\nNote: ideally we would include the estimated error around each line but I haven't figured out how to do this for the type of model we have fitted here.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = augment(m1_hh), \n       aes(x = pronotum_width, y = .fitted, colour = treatment)) +\n  geom_line() +\n  geom_jitter(aes(x = pronotum_width, y = head_horn, colour = treatment), alpha = 0.2) +\n  facet_wrap(~species) +\n  labs(x = \"Pronotum width (mm)\", y = \"Head horn (mm)\") +\n  guides(colour = guide_legend(title = \"Treatment\"))+\n  theme(strip.text = element_text(face = \"italic\"))\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n## Hypothesis #2\n\nNow let's investigate whether these effects persist across the generations.\n\nRecall that our most complete data is for *Onthophagus vacca* shipments 2 and 4 up to generation 3. Let's use just this data for this hypothesis for now.\n\n~~Recall that we didn't see an effect of the treatment on pronotum width for *O. vacca* in generation 1, but we did see an effect on head horns.~~\n\n~~So, here we'll focus just on head horns...~~\n\nAlthough we didn't see an effect of the treatment on pronotum width for *O. vacca* in generation 1, perhaps there is a delayed effect, or something else happening....let's explore this here, along with testing whether the effect on head horns persisted.\n\nFirst, **pronotum width**:\n\n### Step 1: prepare the data\n\nFilter the data to shipments 2 and 4 and remove the 'parental' generation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter data\ndb_data_F1_4 <-\n  db_data %>%\n              filter(shipment %in% c(\"2\", \"4\") &\n                       generation != 0) %>%\n  #mutate(generation = as.factor(generation)) %>%\n  droplevels()\n\n# Check sample sizes\ndb_data_F1_4 %>%\n  drop_na(pronotum_width) %>%\n  group_by(treatment, generation, sex, shipment) %>%\n  count() \n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"treatment\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"generation\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"shipment\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"CT\",\"2\":\"1\",\"3\":\"F\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"1\",\"3\":\"F\",\"4\":\"4\",\"5\":\"25\"},{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"4\",\"5\":\"25\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"F\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"F\",\"4\":\"4\",\"5\":\"24\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"4\",\"5\":\"26\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"F\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"F\",\"4\":\"4\",\"5\":\"25\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"4\",\"5\":\"25\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"F\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"F\",\"4\":\"4\",\"5\":\"17\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"4\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"1\",\"3\":\"F\",\"4\":\"2\",\"5\":\"40\"},{\"1\":\"Q\",\"2\":\"1\",\"3\":\"F\",\"4\":\"4\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"1\",\"3\":\"M\",\"4\":\"2\",\"5\":\"40\"},{\"1\":\"Q\",\"2\":\"1\",\"3\":\"M\",\"4\":\"4\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"2\",\"3\":\"F\",\"4\":\"2\",\"5\":\"15\"},{\"1\":\"Q\",\"2\":\"2\",\"3\":\"F\",\"4\":\"4\",\"5\":\"16\"},{\"1\":\"Q\",\"2\":\"2\",\"3\":\"M\",\"4\":\"2\",\"5\":\"15\"},{\"1\":\"Q\",\"2\":\"2\",\"3\":\"M\",\"4\":\"4\",\"5\":\"14\"},{\"1\":\"Q\",\"2\":\"3\",\"3\":\"F\",\"4\":\"2\",\"5\":\"15\"},{\"1\":\"Q\",\"2\":\"3\",\"3\":\"F\",\"4\":\"4\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"3\",\"3\":\"M\",\"4\":\"2\",\"5\":\"15\"},{\"1\":\"Q\",\"2\":\"3\",\"3\":\"M\",\"4\":\"4\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"4\",\"3\":\"F\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"4\",\"3\":\"M\",\"4\":\"2\",\"5\":\"20\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Step 2: fit the model\n\nBy including an interaction between treatment and generation (treatment\\*generation in the model) we are asking if the treatment effect varies across generations.\n\nNote that because here we have only two shipments, we have moved 'shipment' from being a random to a fixed effect. This is a detail that is not important at this stage, but please ask about this if you wish to discuss.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm2_pw <- lm(pronotum_width ~  + treatment*generation + shipment,\n            data = db_data_F1_4)\n\n# Alternative model to include the three-way interaction\n# m2_pw <- lm(pronotum_width ~  + treatment*generation*shipment,\n#             data = db_data_F1_4)\n```\n:::\n\n\n### Step 3: check model assumptions\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(2,2)); plot(m2_pw); par(mfrow = c(1,1))\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n### Step 4: look at model results\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(m2_pw)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Df\"],\"name\":[1],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"Sum Sq\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Mean Sq\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"F value\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Pr(>F)\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"9.189499\",\"3\":\"9.1894990\",\"4\":\"25.525928\",\"5\":\"5.796122e-07\",\"_rn_\":\"treatment\"},{\"1\":\"1\",\"2\":\"16.692053\",\"3\":\"16.6920527\",\"4\":\"46.365980\",\"5\":\"2.379841e-11\",\"_rn_\":\"generation\"},{\"1\":\"1\",\"2\":\"2.481068\",\"3\":\"2.4810676\",\"4\":\"6.891731\",\"5\":\"8.879536e-03\",\"_rn_\":\"shipment\"},{\"1\":\"1\",\"2\":\"5.512530\",\"3\":\"5.5125303\",\"4\":\"15.312309\",\"5\":\"1.015169e-04\",\"_rn_\":\"treatment:generation\"},{\"1\":\"602\",\"2\":\"216.723893\",\"3\":\"0.3600065\",\"4\":\"NA\",\"5\":\"NA\",\"_rn_\":\"Residuals\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n# We can look at overall fit using the glance() function. Note the adj.r.squared of 0.129. There is a lot of variation that our model is unable to explain.\nglance(m2_pw)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"r.squared\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"adj.r.squared\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sigma\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"p.value\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"logLik\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"AIC\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"BIC\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"deviance\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df.residual\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"nobs\"],\"name\":[12],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.1351767\",\"2\":\"0.1294304\",\"3\":\"0.6000054\",\"4\":\"23.52399\",\"5\":\"4.316742e-18\",\"6\":\"4\",\"7\":\"-548.7196\",\"8\":\"1109.439\",\"9\":\"1135.89\",\"10\":\"216.7239\",\"11\":\"602\",\"12\":\"607\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nThere is for a treatment by generation interaction (treatment:generation term in the anova output) so it seems that although we did not find a treatment effect in the first generation, there is something happening here\\...\n\n### Step 5: understand the model results\n\nI don't find the following hugely helpful but I've left here to show how it's possible to look at the estimated marginal means when there is a continuous term in the model. See how the results are for generation '2.35', that is, we see treatment effect at the average generation:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemmeans(m2_pw, ~ treatment | generation) %>%\n  contrast() %>% tidy()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"generation\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"term\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"contrast\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"null.value\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"estimate\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"std.error\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"adj.p.value\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2.352554\",\"2\":\"treatment\",\"3\":\"CT effect\",\"4\":\"0\",\"5\":\"-0.1302168\",\"6\":\"0.02538636\",\"7\":\"602\",\"8\":\"-5.129399\",\"9\":\"3.925354e-07\"},{\"1\":\"2.352554\",\"2\":\"treatment\",\"3\":\"Q effect\",\"4\":\"0\",\"5\":\"0.1302168\",\"6\":\"0.02538636\",\"7\":\"602\",\"8\":\"5.129399\",\"9\":\"3.925354e-07\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n# Alternative when three-way interaction term included\n# emmeans(m2_pw, ~ treatment | generation, by = \"shipment\") %>%\n#   contrast() %>% tidy()\n```\n:::\n\n\n### Step 6: visualise model predictions alongside raw data\n\nThe following figure shows the predicted pronotum width and how this changes with generation, along with the raw data, for each shipment.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Strip labels are a little tricky to format. The following function is used\n# in facet_wrap below to aid with the labelling.\nappender_ship <- function(string, prefix = \"Shipment: \") paste0(prefix, string)\n\n# Produce figure:\nggplot(data = augment(m2_pw, se_fit = TRUE), \n       aes(x = generation, y = .fitted, colour = treatment)) +\n  geom_line() +\n  geom_ribbon(aes(ymin = .fitted - .se.fit, ymax = .fitted + .se.fit), \n              alpha = 0.2) +\n  geom_jitter(aes(x = generation, y = pronotum_width, colour = treatment), alpha = 0.2) +\n  labs(x = \"Generation\", y = \"Pronotum width (mm)\") +\n  guides(colour = guide_legend(title = \"Treatment\")) +\n  facet_wrap(~shipment, labeller = labeller(shipment = as_labeller(appender_ship)))\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\nYou can see that the 'CT' treatment beetles are predicted to increase in size more quickly across generations compared to the Q beetles.\n\nYou can also see that the model is not a brilliant fit to the data. This could be because we have restricted the slopes of the lines to be the same for each shipment (i.e. we have not included the three-way interaction with shipment in the model). It could also be related to fitting a linear model to data that shows a non-linear pattern.\n\nNow for **head horns**...\n\n### Step 1: prepare the data\n\nAlready done! But we can still check our sample size:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check sample sizes\ndb_data_F1_4 %>%\n  drop_na(head_horn) %>%\n  group_by(treatment, generation, sex, shipment) %>%\n  count() \n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"treatment\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"generation\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"shipment\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"4\",\"5\":\"11\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"4\",\"5\":\"15\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"4\",\"5\":\"15\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"4\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"1\",\"3\":\"M\",\"4\":\"2\",\"5\":\"20\"},{\"1\":\"Q\",\"2\":\"1\",\"3\":\"M\",\"4\":\"4\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"2\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"2\",\"3\":\"M\",\"4\":\"4\",\"5\":\"9\"},{\"1\":\"Q\",\"2\":\"3\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"3\",\"3\":\"M\",\"4\":\"4\",\"5\":\"10\"},{\"1\":\"Q\",\"2\":\"4\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Step 2: fit the model\n\nBy including an interaction between treatment and generation (treatment\\*generation in the model) we are asking if the treatment effect varies across generations.\n\nNote that because here we have only two shipments, we have moved 'shipment' from being a random to a fixed effect. This is a detail that is not important at this stage, but please ask about this if you wish to discuss.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm2_hh <- lm(head_horn ~ pronotum_width + treatment*generation + shipment,\n              data = db_data_F1_4)\n```\n:::\n\n\n### Step 3: check model assumptions\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(2,2)); plot(m2_hh); par(mfrow = c(1,1))\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n### Step 4: look at model results\n\nWe have a high adjusted r squared term (0.804). This will be mostly due to pronotum width doing such a good job explaining head horn size. You can test this by running a model without pronotum width and compared the r squared results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(m2_hh)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Df\"],\"name\":[1],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"Sum Sq\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Mean Sq\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"F value\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Pr(>F)\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"6.889390e+01\",\"3\":\"6.889390e+01\",\"4\":\"6.950536e+02\",\"5\":\"7.358253e-61\",\"_rn_\":\"pronotum_width\"},{\"1\":\"1\",\"2\":\"4.574447e-01\",\"3\":\"4.574447e-01\",\"4\":\"4.615047e+00\",\"5\":\"3.316032e-02\",\"_rn_\":\"treatment\"},{\"1\":\"1\",\"2\":\"5.365254e-05\",\"3\":\"5.365254e-05\",\"4\":\"5.412873e-04\",\"5\":\"9.814667e-01\",\"_rn_\":\"generation\"},{\"1\":\"1\",\"2\":\"1.344098e-02\",\"3\":\"1.344098e-02\",\"4\":\"1.356028e-01\",\"5\":\"7.131671e-01\",\"_rn_\":\"shipment\"},{\"1\":\"1\",\"2\":\"1.118786e-02\",\"3\":\"1.118786e-02\",\"4\":\"1.128715e-01\",\"5\":\"7.373278e-01\",\"_rn_\":\"treatment:generation\"},{\"1\":\"164\",\"2\":\"1.625572e+01\",\"3\":\"9.912027e-02\",\"4\":\"NA\",\"5\":\"NA\",\"_rn_\":\"Residuals\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nglance(m2_hh)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"r.squared\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"adj.r.squared\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sigma\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"p.value\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"logLik\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"AIC\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"BIC\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"deviance\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df.residual\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"nobs\"],\"name\":[12],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.8101671\",\"2\":\"0.8043795\",\"3\":\"0.3148337\",\"4\":\"139.9835\",\"5\":\"2.806055e-57\",\"6\":\"5\",\"7\":\"-41.69451\",\"8\":\"97.38903\",\"9\":\"119.3396\",\"10\":\"16.25572\",\"11\":\"164\",\"12\":\"170\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nThere is no evidence for a treatment by generation interaction (treatment:generation term in the anova output), but there is an effect of treatment. This suggests that there is a treatment effect (consistent with our earlier finding) and that this persists through time.\n\nIt could also mean that we lacked the power necessary to detect the interaction effect....\n\n### Step 5: understand the model results\n\nThe same applies here as to my comments above about pronotum width.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemmeans(m2_hh, ~ treatment | generation) %>%\n  contrast() %>% tidy()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"generation\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"term\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"contrast\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"null.value\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"estimate\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"std.error\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"adj.p.value\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2.317647\",\"2\":\"treatment\",\"3\":\"CT effect\",\"4\":\"0\",\"5\":\"-0.05025408\",\"6\":\"0.02511557\",\"7\":\"164\",\"8\":\"-2.000913\",\"9\":\"0.04705141\"},{\"1\":\"2.317647\",\"2\":\"treatment\",\"3\":\"Q effect\",\"4\":\"0\",\"5\":\"0.05025408\",\"6\":\"0.02511557\",\"7\":\"164\",\"8\":\"2.000913\",\"9\":\"0.04705141\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nThe Q beetles have larger horns relative to their body size compared to the CT beetles.\n\n### Step 6: visualise model predictions alongside raw data\n\nThe following figure shows the predicted head horn size for a given pronotum width, along with the raw data, for each generation x shipment combination.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Strip labels are a little tricky to format. The following functions are used\n# in facet_grid below to aid with the labelling.\nappender_gen <- function(string, prefix = \"Generation: \") paste0(prefix, string)\nappender_ship <- function(string, prefix = \"Shipment: \") paste0(prefix, string)\n\n# Produce figure:\nggplot(data = augment(m2_hh, se_fit = TRUE), \n       aes(x = pronotum_width, y = .fitted, colour = treatment)) +\n  geom_line() +\n  geom_ribbon(aes(ymin = .fitted - .se.fit, ymax = .fitted + .se.fit), \n              alpha = 0.2) +\n  geom_jitter(aes(x = pronotum_width, y = head_horn, colour = treatment), alpha = 0.2) +\n  labs(x = \"Pronotum width (mm)\", y = \"Head horn (mm)\") +\n  guides(colour = guide_legend(title = \"Treatment\")) +\n  facet_grid(rows = vars(shipment), cols = vars(generation),\n             labeller = labeller(generation =  as_labeller(appender_gen),\n                                 shipment = as_labeller(appender_ship)))\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n## Hypothesis #3\n\nWe have found evidence that the treatment affected relative horn length and that this effect persisted for multiple generations.\n\nInterestingly, there did not appear to be any effect of generation.\n\nHowever, we used only a subset of the data in the above model. What if we use all the CT data we have that includes horn measures. This may increase our power to detect an effect of generation (i.e. does relative horn size change over time in 'captive' breeding).\n\n### Step 1: prepare the data\n\nFilter the data to *O. vacca* CT beetles.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndb_data_vac_CT <- \n  db_data %>%\n  filter(species == \"Onthophagus vacca\" &\n           treatment == \"CT\") %>%\n  droplevels()\n\n# Check sample sizes\ndb_data_vac_CT %>%\n  drop_na(head_horn) %>%\n  group_by(treatment, generation, sex, shipment) %>%\n  count() \n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"treatment\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"generation\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"shipment\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"4\",\"5\":\"11\"},{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"5A\",\"5\":\"15\"},{\"1\":\"CT\",\"2\":\"1\",\"3\":\"M\",\"4\":\"5B\",\"5\":\"13\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"4\",\"5\":\"15\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"5A\",\"5\":\"15\"},{\"1\":\"CT\",\"2\":\"2\",\"3\":\"M\",\"4\":\"5B\",\"5\":\"14\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"4\",\"5\":\"15\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"5A\",\"5\":\"15\"},{\"1\":\"CT\",\"2\":\"3\",\"3\":\"M\",\"4\":\"5B\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"2\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"4\",\"5\":\"10\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"5A\",\"5\":\"4\"},{\"1\":\"CT\",\"2\":\"4\",\"3\":\"M\",\"4\":\"5B\",\"5\":\"10\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Step 2: fit the model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm3_hh <- lmer(head_horn ~ pronotum_width + generation + (1|shipment),\n              data = db_data_vac_CT)\n```\n:::\n\n\n### Step 3: check model assumptions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(m3_hh)\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(data = augment(m3_hh), aes(x = .resid)) +\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-29-2.png){width=672}\n:::\n:::\n\n\n### Step 4: look at model results\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAnova(m3_hh)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Chisq\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Df\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Pr(>Chisq)\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"511.1870154\",\"2\":\"1\",\"3\":\"3.499087e-113\",\"_rn_\":\"pronotum_width\"},{\"1\":\"0.6175725\",\"2\":\"1\",\"3\":\"4.319508e-01\",\"_rn_\":\"generation\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nThere is no evidence for an effect of generation on horn length, but as in previous models there is a strong effect of pronotum width.\n\n### Step 5: understand the model results\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(m3_hh)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"effect\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"group\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"term\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"estimate\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"std.error\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"fixed\",\"2\":\"NA\",\"3\":\"(Intercept)\",\"4\":\"-3.32858227\",\"5\":\"0.20423888\",\"6\":\"-16.2974960\"},{\"1\":\"fixed\",\"2\":\"NA\",\"3\":\"pronotum_width\",\"4\":\"1.01003607\",\"5\":\"0.04467319\",\"6\":\"22.6094453\"},{\"1\":\"fixed\",\"2\":\"NA\",\"3\":\"generation\",\"4\":\"-0.02053446\",\"5\":\"0.02612999\",\"6\":\"-0.7858578\"},{\"1\":\"ran_pars\",\"2\":\"shipment\",\"3\":\"sd__(Intercept)\",\"4\":\"0.14497118\",\"5\":\"NA\",\"6\":\"NA\"},{\"1\":\"ran_pars\",\"2\":\"Residual\",\"3\":\"sd__Observation\",\"4\":\"0.32039311\",\"5\":\"NA\",\"6\":\"NA\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nWe see there is a positive effect of pronotum width on horn length (see the positive estimate of the pronotum_width term). That is, as pronotum width increases, so does horn length.\n\nNothing surprising here - this was the reason we included pronotum width in the models in the first place.\n\n### Step 6: visualise e raw data\n\nIf we want to visualise the relationship between pronotum width and horn length we can use the following:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = db_data_vac_CT, aes(x = pronotum_width, y = head_horn, colour = generation)) +\n  geom_point() +\n  scale_colour_viridis_c() +\n  labs(y = \"Horn length (mm)\", x = \"Pronotum width (mm)\") +\n  guides(colour = guide_legend(title = \"Generation\"))\n```\n\n::: {.cell-output-display}\n![](dung_beetles_data_modelling_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n\nYou can see that as we increase generation (colours of the points), *O. vacca* males get larger horns but this is all down to them getting bigger!\n",
    "supporting": [
      "dung_beetles_data_modelling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}